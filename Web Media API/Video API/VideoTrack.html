<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./css/vjs.zencdn.net_8.5.2_video-js.css" />
    <!-- If you'd like to support IE8 (for Video.js versions prior to v7) -->
    <!-- <script src="https://vjs.zencdn.net/ie8/1.1.2/videojs-ie8.min.js"></script> -->
    <title>VideoTrack() 视频音轨</title>
    <style>
      li {
        line-height: 50px;
      }
    </style>
  </head>

  <body>
    <h1>VideoTrack() 视频音轨</h1>
    <hr />
    <div>
      <!-- muted静音自动播放
      <video muted autoplay loop controls src="./202107.mp4"></video>  -->

      <video
        id="video"
        class="video-js"
        controls
        preload="auto"
        poster="./img/poster.png"
        data-setup="{}"
      >
        <source src="./media/202107.mp4" type="video/mp4" />
        <p class="vjs-no-js">
          要观看此视频，请启用JavaScript，并升级浏览器！
          <a href="https://videojs.com/html5-video-support/" target="_blank"
            >支持HTML5视频</a
          >
        </p>
      </video>
    </div>

    <br /><br />

    <div>
      <input type="text" id="text" />
      <button type="button" id="add">添加音轨</button>
      <h2>音轨列表</h2>
      <ul id="trackList"></ul>
    </div>

    <script src="./js/vjs.zencdn.net_8.5.2_video.min.js"></script>
    <script>
      {
        // 首先获取video元素
        const video = document.querySelector("video");

        // 等待视频文件加载完毕
        video.addEventListener("loadedmetadata", function () {
          try {
            // audioTracks属性是检查audio中的否为空， 而在video中用videoTracks
            console.log("video.videoTracks：", video.videoTracks);
            if (video.videoTracks.length > 0) {
              console.log("该视频文件有声音！");
            } else {
              console.log("该视频文件没有声音！");
            }
          } catch {
            console.log('video.mediaSession：', video.mediaSession);
            var mediaPlayer = video.mediaSession.sink;
            // 获取并显示音频轨道数量
            var length = mediaPlayer.tracks.length;
            if (length > 0) {
              console.log("该视频文件有声音！");
            } else {
              console.log("该视频文件没有声音！");
            }
          } finally {
            console.log("该视频文件不能确定是否有声音！");
          }
        });
      }

      class VideoTrack {
        constructor({ video_el = "", track_el = "" }) {
          if ("function" != typeof videojs) {
            throw new TypeError("请添加video.js文件！");
          }
          if (!video_el) {
            throw new TypeError("请传入video标签id！");
          }
          this.video_el = video_el;
          this.track_el = document.querySelector(track_el);

          // https://videojs.com/guides/video-tracks
          this.player = videojs(this.video_el);

          this.render();
        }

        add({
          id = Math.random().toString(36).substring(2),
          kind = "commentary",
          label = "Spanish-" + Date.now(),
          language = "en",
          selected = Boolean(Math.random() > 0.5),
        } = {}) {
          try {
            //  创建轨迹对象
            const track = new videojs.VideoTrack({
              id, // 视频轨
              kind, // "alternative"：主轨道的可能替代方案。"captions"：带有刻录字幕的主视频轨道"main"：主视频轨道。"sign"：添加了手语叠加层的主视频轨道。"subtitles"：带有刻录字幕的主要视频轨道。"commentary"：在评论中刻录的主要视频轨道。""（默认值）：没有显式类型，或者用户代理无法识别轨道元数据给出的类型。
              label,
              language,
              selected,
            });
            // 将曲目添加到播放器的视频曲目列表中。
            this.player.videoTracks().addTrack(track);
          } catch (err) {
            console.error(err);
          } finally {
            this.render();
          }
        }

        del(id = "") {
          if (!id) {
            alert("id不能为空！");
          }
          try {
            if (confirm("是否确定删除？")) {
              const track = this.player.videoTracks().getTrackById(id);
              // 将其从视频曲目列表中删除。
              this.player.videoTracks().removeTrack(track);
            }
          } catch (err) {
            console.error(err);
          } finally {
            this.render();
          }
        }

        tracks() {
          const videoTracks = this.player.videoTracks();

          // 监听视频改变事件
          videoTracks.addEventListener("change", (e) => {
            console.log("videoTracks Change", e);

            // 记录当前启用的VideoTrack标签
            for (let i = 0; i < videoTracks.length; i++) {
              const track = videoTracks[i];

              if (track.enabled) {
                return this.player.log(track.label);
              }
            }
          });
          return videoTracks;
        }

        render() {
          const { length, tracks_ } = this.tracks();

          if (length) {
            let li = "";
            for (let i = 0; i < length; i++) {
              const { id, kind, label, language, selected } = tracks_[i];
              li += `<li>${
                i + 1
              }、<b>ID：${id}；</b> kind：${kind}；label：${label}；language：${language}；selected：${selected}； <button type="button" onClick="vt.del('${id}')">⚔️删除音轨</button>`;
            }
            this.track_el.innerHTML = li;
          }
        }
      }

      const vt = new VideoTrack({
        video_el: "video",
        track_el: "#trackList",
      });

      console.log("player", vt.player);

      // const video = document.querySelector('#video');
      // console.dir(video);

      const text = document.querySelector("#text");
      document.querySelector("#add").addEventListener("click", (event) => {
        text.value ? vt.add({ id: text.value }) : vt.add();
      });
    </script>
  </body>
</html>
