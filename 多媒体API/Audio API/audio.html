<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Audio API examples: MediaElementAudioSource()</title>
  </head>

  <body>
    <h1>Web Audio API examples: MediaElementAudioSource()</h1>
    <p>
      Position the cursor vertically to change the volume (down is louder).
      将光标垂直放置以更改音量（向下音量更大）。
    </p>

    <audio mute controls>
      <source src="./media/hlbb.mp3" type="audio/mp3" />
      <source src="./media/viper.ogg" type="audio/ogg" />
      <p>This demo needs a browser supporting the &lt;audio&gt; element.</p>
    </audio>

    <br />
    <input type="range" id="range" min="0" max="1000" />
    <input type="range" min="0" max="100" id="volume" />
    <script>
      {
        /*
        let audioCtx;
        const audioElement = document.querySelector("audio");

        audioElement.addEventListener("play", () => {
        audioCtx = new AudioContext();
        // Create a MediaElementAudioSourceNode
        // Feed the HTMLMediaElement into it
          let source = new MediaElementAudioSourceNode(audioCtx, {
            mediaElement: audioElement,
          });

          // Create a gain node
          let gainNode = new GainNode(audioCtx);

          // Create variables to store mouse pointer Y coordinate
          // and HEIGHT of screen
          let currentY;
          let height = window.innerHeight;

          // Get new mouse pointer coordinates when mouse is moved
          // then set new gain value

          document.onmousemove = (e) => {
            currentY = window.Event
              ? e.pageY
              : event.clientY +
                (document.documentElement.scrollTop
                  ? document.documentElement.scrollTop
                  : document.body.scrollTop);

            gainNode.gain.value = currentY / height;
          };
          
          //将AudioBufferSourceNode连接到gainNode
          //和gainNode到目的地，这样我们就可以玩
          //音乐并使用鼠标光标调整音量
          source.connect(gainNode);
          gainNode.connect(audioCtx.destination);
        });
       */
      }

      {
        var audioCtx = new AudioContext();
        // var url = './media/hlbb.mp3';
        // var audio = new Audio(url);
        const audio = document.querySelector("audio");

        var processor = audioCtx.createScriptProcessor(2048, 1, 1);
        var meter = document.getElementById("meter");
        var source;

        audio.addEventListener(
          "canplaythrough",
          function () {
            source = audioCtx.createMediaElementSource(audio);
            source.connect(processor);
            source.connect(audioCtx.destination);
            processor.connect(audioCtx.destination);

            audio.play();
          },
          false
        );

        // 循环PCM数据并计算平均值
        // 给定2048样本缓冲区的体积
        processor.onaudioprocess = function (evt) {
          var input = evt.inputBuffer.getChannelData(0),
            len = input.length,
            total = (i = 0),
            rms;
          while (i < len) total += Math.abs(input[i++]);
          rms = Math.sqrt(total / len);

          // console.log(input, rms, rms * 100);
          range.value = rms * 1000;
        };
      }
    </script>

    <script type="text/javascript">
      var tank = new Audio("http://qianduannotes.duapp.com/file/tankWar.mp3");
      tank.loop = true;
      var mario = new Audio(
        "http://qianduannotes.duapp.com/file/SuperMario.mp3"
      );
      mario.loop = true;

      var AudioContext = AudioContext || webkitAudioContext;
      var context = new AudioContext();
      var source1 = context.createMediaElementSource(tank);
      var source2 = context.createMediaElementSource(mario);
      var gain1 = context.createGain();
      var gain2 = context.createGain(); //连接：source → gain → destination    source1.connect(gain1);
      source2.connect(gain2);
      gain1.connect(context.destination);
      gain2.connect(context.destination); //音量控制
      var value;
      onload = volume.onchange = function () {
        gain1.gain.value = volume.value / 100;
        gain2.gain.value = 1 - volume.value / 100;
      };

      tank.onload = mario.onlond = function () {
        console.log("var1, var2");
      };
      tank.play();
      mario.play();
    </script>
  </body>
</html>
