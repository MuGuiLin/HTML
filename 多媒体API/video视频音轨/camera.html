<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Title</title>
  </head>
  <style>
    video {
      width: 50%;
      height: 50%;
      margin: 50px auto;
      background-color: rgba(255, 232, 198, 0.53);
      display: block;
    }
  </style>
  <script type="text/javascript" src="./js/jquery.3.6.0.min.js"></script>
  <body>
    <input type="file" multiple accept="" />
    <hr />
    <div>
      <video id="video"></video>
    </div>
    <button onclick="openCamera()">打开Camera</button>
    <button onclick="stopRecording()">停止recording</button>
    <button onclick="saveRecording()">保存recording</button>

    <hr />
    <div class="record-wrap">
      <h5>预览区域</h5>
      <div class="video-list" id="videoWrap">暂无视频</div>
      <p class="tips">
        点击视频即可下载<b class="batch-download" id="batchDownloadVideos">批量下载</b >
      </p>
    </div>
  </body>
</html>
<script>
  // https://blog.csdn.net/weixin_41960204/article/details/110857225
  const videoWrap = document.getElementById("videoWrap"); // 视频预览
  const video = document.getElementById("video");
  const setting = {
    audio: {
      sampleRate: "32000HZ",
      sampleSize: 16,
      volume: 0.3,
      echoCancellation: true,
      autoGainControl: false,
      noiseSuppression: true,
      latency: 3,
      channelCount: 2,
    },
    // audio:true,
    video: {
      facingMode: "user", // 'user'前置摄像头 ‘environment’代表后置摄像头。笔记本只有前置，这个不确定行不行
      width: 400,
      height: 250,
      noiseSuppression: true,
      frameRate: {
        ideal: 10,
        max: 15,
      },
    },
  };
  var options = {
    // 这个配置我还用到，可以忽略，
    audioBitsPerSecond: 128000,
    videoBitsPerSecond: 2500000,
    mimeType: "video/ogg",
  };
  function openCamera() {
    if (navigator.mediaDevices) {
      navigator.mediaDevices.getUserMedia(setting).then(success).catch(error);
    } else if (navigator.webkitGetUserMedia) {
      //webkit核心浏览器
      navigator.webkitGetUserMedia(
        { video: { width: 1000, height: 1000 }, audio: true },
        success,
        error
      );
    } else if (navigator.mozGetUserMedia) {
      //firfox浏览器
      navigator.mozGetUserMedia(
        { video: { width: 1000, height: 1000 }, audio: true },
        success,
        error
      );
    } else if (navigator.getUserMedia) {
      //旧版API
      navigator.getUserMedia(
        { video: { width: 1000, height: 1000 }, audio: true },
        success,
        error
      );
    }
  }

  function success(stream) {
    video.srcObject = stream;
    video.play(); // 播放
    startRecording(stream); // 录屏
  }
  function error(error) {
    console.log(`访问用户媒体设备失败${error.name}, ${error.message}`);
    // alert(`访问用户媒体设备失败${error.name}, ${error.message}`)
  }

  var chunks = [];
  var mediaRecorder = {};
  function startRecording(stream) {
    alert("录制视频");
    mediaRecorder = new MediaRecorder(stream);

    //为了收集录制的数据，需要监听 ondataavailable 事件
    chunks = [];
    mediaRecorder.ondataavailable = function (e) {
      console.log(e.data);
      // chunks.push(e.data)
      chunks = e.data;
    };
    // 开始录制
    mediaRecorder.start();
    console.log("媒体流的状态： " + mediaRecorder.state);
  }

  function stopRecording() {
    mediaRecorder.stop();
  }

  function saveRecording() {
    let videoTag = document.createElement("video");
    videoTag.width = video.width / 3;
    videoTag.height = video.height / 3;
    videoTag.controls = true;
    // chunk 为Blob对象
    creatFileObj(chunks, "aa.mp4");
    let src = window.URL.createObjectURL(chunks);
    chunks = "";
    mediaRecorder = null;
    videoTag.src = src; // 注意这里不要弄到当前实时画面的 video 对象中，因为实时的 video 中是有流的
    videoWrap.appendChild(videoTag);
  }

  function creatFileObj(blob, fileName) {
    var file = new File([blob], "aa.mp4"); // 将 blob 转为 file 对象，
    for (var key in file) {
      console.log(key + " ===> " + file[key]);
    }
  }
</script>
