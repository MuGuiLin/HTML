<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>video视频音轨</title>
  </head>

  <body>
    <h1>video视频音轨</h1>
    <hr />
    <div>
      <!-- muted静音自动播放 -->
      <video muted autoplay loop controls src="./media/202107.mp4"></video>

      <video id="video" loop controls>
        <source src="./media/202107.mp4" type="video/mp4" />
        <source src="./media/hero.mp4" type="video/mp4" />
      </video>

      <br /> <hr /> <br />

      <video id="my-video" loop controls>
        <source src="./media/202107.mp4" type="video/mp4" />
        <source src="./media/hero.mp4" type="video/mp4" />
      </video>

      <button type="button" id="selectLang">video视频音轨</button>
    </div>

    <script>
      const video = document.querySelector("#video");
      console.dir(video);

      function hasAudio(video) {
        return (
          video.mozHasAudio ||
          Boolean(video.webkitAudioDecodedByteCount) ||
          Boolean(video.audioTracks && video.audioTracks.length)
        );
      }

      function hasAudio2(video) {
        if (typeof video.webkitAudioDecodedByteCount !== "undefined") {
          // 如果视频有音轨，则为非零
          if (video.webkitAudioDecodedByteCount > 0) {
            console.log(
              `video has audio 视频有${video.webkitAudioDecodedByteCount}个音频`
            );

            console.log(video.audioTracks);
          } else {
            console.log("video doesn't have audio 视频没有音频");
          }
        } else if (typeof video.mozHasAudio !== "undefined") {
          // 如果视频有音轨，则为true
          if (video.mozHasAudio) {
            console.log("video has audio 视频有音频");
          } else {
            console.log("video doesn't have audio 视频没有音频");
          }
        } else {
          console.log("can't tell if video has audio 无法判断视频是否有音频！");
        }
      }

      function selectLang(video) {
        if (video.audioTracks.length > 1) {
          for (var i = 0; i < video.audioTracks.length; i++) {
            if (video.audioTracks[i].language == "en-gb") {
              video.audioTracks[i].enabled = true;
            } else {
              video.audioTracks[i].enabled = false;
            }
          }
        }
        video.play();
      }

      video.addEventListener("loadeddata", async function () {
        // after waiting for the "canplaythrough" event: 等待“canplaythrough”事件后
        // video.play(); // 注：必须是用户与页面交互，否则它不允许某些事件工作，除非将video设为mute静音！
        await new Promise((r) => setTimeout(r, 1000));
        hasAudio2(video);
        console.log(hasAudio(video));
      });

      video.addEventListener("play", function () {
        hasAudio2(video);
        console.log(hasAudio(video));
      });

      {
        var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        var myAudio = document.querySelector("video");
        var pre = document.querySelector("pre");
        var myScript = document.querySelector("script");

        pre.innerHTML = myScript.innerHTML;

        // Create a MediaElementAudioSourceNode
        // Feed the HTMLMediaElement into it
        var source = audioCtx.createMediaElementSource(myAudio);

        // Create a gain node
        var gainNode = audioCtx.createGain();

        // Create variables to store mouse pointer Y coordinate
        // and HEIGHT of screen
        var CurY;
        var HEIGHT = window.innerHeight;

        // Get new mouse pointer coordinates when mouse is moved
        // then set new gain value

        document.onmousemove = updatePage;

        function updatePage(e) {
          CurY = window.Event
            ? e.pageY
            : event.clientY +
              (document.documentElement.scrollTop
                ? document.documentElement.scrollTop
                : document.body.scrollTop);

          gainNode.gain.value = CurY / HEIGHT;
        }

        // connect the AudioBufferSourceNode to the gainNode
        // and the gainNode to the destination, so we can play the
        // music and adjust the volume using the mouse cursor
        source.connect(gainNode);
        gainNode.connect(audioCtx.destination);
      }

      {
        function selectLang() {
          const myVideo = document.getElementById("my-video");
          console.dir(myVideo);
          console.log(myVideo.audioTracks);
          if (myVideo.audioTracks.length > 1) {
            for (let i = 0; i < myVideo.audioTracks.length; i++) {
              if (myVideo.audioTracks[i].language == "en-gb") {
                myVideo.audioTracks[i].enabled = true;
              } else {
                myVideo.audioTracks[i].enabled = false;
              }
            }
          }
          myVideo.play();
        }

        document.querySelector("#selectLang").addEventListener(
          "click",
          function (e) {
            selectLang(video);
          },
          {
            once: false, // 只执行一次。
            passive: true, //承诺此事件监听不会调用 preventDefault，这有助于性能。
            useCaptureL: false, // 是否捕获（否则冒泡）。
          }
        );
      }
    </script>
  </body>
</html>
